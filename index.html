documentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const docId = documentIdInput.value;
    const title = documentTitleInput.value;
    const department = documentDepartmentInput.value;
    const submitter = documentSubmitterInput.value;
    const status = documentStatusInput.value;
    const remarks = documentRemarksInput.value;
    let documentNumber = '';
    let newDocId = docId;
    documentSaveBtn.textContent = 'Saving...';
    documentSaveBtn.disabled = true;
    let error = null;
    if (docId) {
        // Update existing document
        const { error: updateError } = await supabase
            .from('documents')
            .update({
                title: title,
                department: department,
                submitter: submitter,
                status: status,
                remarks: remarks
            })
            .eq('id', docId);
        error = updateError;
        if (!error) {
            // Get the existing document number for history logging
            const existingDoc = documents.find(d => d.id === docId);
            if (existingDoc) {
                documentNumber = existingDoc.documentNumber;
            }
        }
    } else {
        // Add new document
        const today = new Date();
        const year = today.getFullYear().toString().slice(-2);
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        const count = documents.length + 1;
        documentNumber = `LGU-${year}${month}-${count}`;
        const { data, error: insertError } = await supabase
            .from('documents')
            .insert([{ 
                title: title,
                department: department,
                submitter: submitter,
                status: status,
                documentNumber: documentNumber,
                remarks: remarks,
                processingDays: 0
            }])
            .select();
        error = insertError;
        if (data && data.length > 0) {
            newDocId = data[0].id;
        }
    }
    if (error) {
        console.error('Error saving document:', error.message);
        showStatusModal(`Error saving document: ${error.message}`);
    } else {
        // Add a new history entry
        const historyEntry = {
            document_id: newDocId,
            status: status,
            remarks: remarks
        };
        const { error: historyError } = await supabase.from('document_history').insert([historyEntry]);
        if (historyError) {
            console.error('Error saving document history:', historyError.message);
        }
        showStatusModal(`Document saved successfully!`);
        documentForm.reset();
    }
    documentSaveBtn.textContent = 'Save Document';
    documentSaveBtn.disabled = false;
    closeModal();
    fetchDocuments(); // Refresh the list of documents
});